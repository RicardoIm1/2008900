<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Defunciones</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    @media (min-width: 768px) {
      .main-container {
        grid-template-columns: 35% 65%;
      }
    }
  </style>
</head>

<body class="text-gray-800" style="background-color: #f5f4ec;">
  <div class="max-w-screen-2xl mx-auto py-8 px-4">
<div class="max-w-screen-2xl mx-auto py-8 px-4">
  
  <!-- Título -->
  <h1 class="text-3xl font-bold mb-6 text-center">Registro de Defunciones</h1>

  <!-- Notificación Toast -->
  <div id="toast"
    class="hidden fixed bottom-5 right-5 p-4 rounded-lg shadow-lg flex items-start transition-all duration-300 translate-y-10 opacity-0">
    <span id="toast-icon" class="mr-2"></span>
    <span id="toast-message"></span>
  </div>

  <!-- Grid principal: barra + formulario + tabla -->
<div class="max-w-screen-2xl mx-auto py-8 px-4">
  <div class="grid md:grid-cols-[30%_70%] gap-6 min-h-[600px]">

    <!-- Barra de progreso: ocupa las 2 columnas -->
    <div class="col-span-2 mb-6 bg-white p-5 rounded-lg shadow w-full">
      <div class="flex justify-between mb-1">
        <span class="font-semibold">Progreso mensual</span>
        <span id="progress-text" class="font-medium">0/30 registros</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4">
        <div id="progress-bar" class="h-4 rounded-full bg-blue-600" style="width: 100%"></div>
      </div>
    </div>

    <!-- Formulario CRUD -->
    <form id="crud-form" class="bg-white p-6 rounded-lg shadow-md h-full sticky top-4">
      <input type="hidden" id="registro-id">

      <div class="grid md:grid-cols-2 gap-4 mb-4">
        <div>
          <label for="folio" class="block text-sm font-medium text-gray-700 mb-1">Folio</label>
          <input id="folio" placeholder="Ej. FOL-001" maxlength="50" 
                class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
            Nombre <span class="text-red-500 ml-1">*</span>
            <span id="nombre-error" class="text-red-500 text-xs ml-2 hidden">Campo obligatorio</span>
          </label>
          <input id="nombre" placeholder="Nombre completo" maxlength="100" required
                class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500 invalid:border-red-500">
        </div>
        <div>
          <label for="fechaDefuncion" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Defunción</label>
          <input id="fechaDefuncion" type="date" 
                class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500">
          <span id="fecha-error" class="text-red-500 text-xs hidden">La fecha no puede ser futura</span>
        </div>
        <div>
          <label for="area" class="block text-sm font-medium text-gray-700 mb-1">Área</label>
          <select id="area" class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500">
            <option value="">Seleccione un área</option>
            <option value="Censados">Censados</option>
            <option value="Urgencias">Urgencias</option>
            <option value="Corta Estancia">Corta Estancia</option>
            <option value="Externo">Externo</option>
            <option value="MP">MP</option>
          </select>
        </div>
        <div>
          <label for="edad" class="block text-sm font-medium text-gray-700 mb-1">Edad</label>
          <input id="edad" type="number" min="0" max="120" placeholder="Edad" 
                class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Sexo</label>
          <div class="flex flex-wrap gap-2">
            <label class="inline-flex items-center">
              <input type="radio" name="sexo" value="Masculino" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
              <span class="ml-2">Masculino</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="sexo" value="Femenino" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
              <span class="ml-2">Femenino</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="sexo" value="Intersexual" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
              <span class="ml-2">Intersexual</span>
            </label>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4 mb-4">
        <div>
          <label for="expediente" class="block text-sm font-medium text-gray-700 mb-1">Expediente</label>
          <input id="expediente" placeholder="Número de expediente" maxlength="20" 
                class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="medico" class="block text-sm font-medium text-gray-700 mb-1">Médico que certifica</label>
          <input id="medico" placeholder="Nombre del médico" maxlength="100" 
                class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <div class="mb-4">
        <label for="diagnostico" class="block text-sm font-medium text-gray-700 mb-1">Diagnóstico causa de la muerte</label>
        <textarea id="diagnostico" placeholder="Descripción del diagnóstico" maxlength="500" 
                  class="border p-2 rounded w-full h-24 focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      <div class="mb-4">
        <label for="observaciones" class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
        <textarea id="observaciones" placeholder="Notas adicionales" maxlength="1000" 
                  class="border p-2 rounded w-full h-20 focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      <div class="mt-6 flex space-x-3">
        <button type="submit" id="btn-submit"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center">
          <span id="submit-text"><i class="fas fa-save mr-2"></i> Guardar</span>
          <span id="submit-loading" class="hidden ml-2">
            <i class="fas fa-spinner fa-spin"></i> Procesando...
          </span>
        </button>
        <button type="button" id="btn-limpiar"
          class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded flex items-center">
          <i class="fas fa-broom mr-2"></i> Limpiar
        </button>
      </div>
    </form>

    <!-- Tabla de registros -->
    <div class="bg-white p-6 rounded-lg shadow-md overflow-auto max-h-[47rem] overflow-auto">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
        <h2 class="text-xl font-semibold">Registros Existentes</h2>
        <div class="relative w-full md:w-auto">
          <input type="text" id="buscar-registro" placeholder="Buscar..."
            class="border p-2 pl-8 rounded w-full md:w-64 focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-search absolute left-2 top-3 text-gray-400"></i>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left">
          <thead class="bg-gray-100">
            <tr>
              <th class="p-3 font-medium">Número</th>
              <th class="p-3 font-medium">Folio</th>
              <th class="p-3 font-medium">Nombre</th>
              <th class="p-3 font-medium">Fecha</th>
              <th class="p-3 font-medium">Área</th>
              <th class="p-3 font-medium">Observaciones</th>
              <th class="p-3 font-medium">Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-registros" class="divide-y divide-gray-200">
            <tr>
              <td colspan="6" class="text-center p-4 text-gray-500">Cargando registros...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

</div>

  </div>

  <script>
    let allRecords = [];

// Mostrar notificación tipo toast (unificada)
function showToast(msg, type = "success") {
  const toast = document.getElementById('toast');
  const icon = document.getElementById('toast-icon');
  const message = document.getElementById('toast-message');

  // Configurar apariencia
  toast.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg flex items-start transition-all duration-300`;

  if (type === "success") {
    icon.innerHTML = '<i class="fas fa-check-circle text-xl mr-2 text-green-500"></i>';
    toast.classList.add("bg-green-600", "text-white");
  } else if (type === "error") {
    icon.innerHTML = '<i class="fas fa-exclamation-circle text-xl mr-2 text-red-500"></i>';
    toast.classList.add("bg-red-600", "text-white");
  } else {
    icon.innerHTML = '<i class="fas fa-info-circle text-xl mr-2 text-blue-500"></i>';
    toast.classList.add("bg-blue-600", "text-white");
  }

  message.textContent = msg;

  // Animación de entrada
  toast.classList.remove('hidden', 'translate-y-10', 'opacity-0');
  setTimeout(() => {
    toast.classList.add('translate-y-0', 'opacity-100');
  }, 10);

  // Ocultar a los 3 segundos
  setTimeout(() => {
    toast.classList.add('translate-y-10', 'opacity-0');
    setTimeout(() => toast.classList.add('hidden'), 300);
  }, 3000);
}

// Función para mostrar estado de carga
function setLoading(isLoading) {
  const btn = document.getElementById('btn-submit');
  const text = document.getElementById('submit-text');
  const loading = document.getElementById('submit-loading');
  
  if (isLoading) {
    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-not-allowed');
    text.classList.add('hidden');
    loading.classList.remove('hidden');
  } else {
    btn.disabled = false;
    btn.classList.remove('opacity-75', 'cursor-not-allowed');
    text.classList.remove('hidden');
    loading.classList.add('hidden');
  }
}

// Renderizar tabla con los nuevos nombres de campos
function renderTable(records) {
  const tbody = document.getElementById('tabla-registros');
  
  if (!records || records.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center p-8 text-gray-500">
          <i class="far fa-folder-open text-3xl mb-2 block mx-auto"></i>
          <span class="text-lg">No hay registros encontrados</span>
        </td>
      </tr>`;
    return;
  }
  
  tbody.innerHTML = records.map(record => {
    const fecha = record.fechaDefuncion ? 
      new Date(record.fechaDefuncion).toLocaleDateString('es-MX') : '';
    
    return `
      <tr class="hover:bg-gray-50" data-id="${record.ID}">
        <td class="p-3">${record.numero || 'N/A'}</td>
        <td class="p-3">${record.folio || 'N/A'}</td>
        <td class="p-3">${record.nombre || 'Sin nombre'}</td>
        <td class="p-3">${fecha}</td>
        <td class="p-3">${record.area || 'N/A'}</td>
        <td class="p-3">${record.observaciones || 'Sin observaciones'}</td>
        <td class="p-3 space-x-1 whitespace-nowrap">
          <button onclick='editarRegistro(${JSON.stringify(record).replace(/"/g, '&quot;')})' 
            class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-sm">
            <i class="fas fa-edit mr-1"></i> Editar
          </button>
          <button onclick='confirmarEliminacion("${record.ID}")' 
            class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
            <i class="fas fa-trash-alt mr-1"></i> Eliminar
          </button>
        </td>
      </tr>`;
  }).join('');
}

// Cargar registros desde Google Sheets
function cargarRegistros() {
  const tbody = document.getElementById('tabla-registros');
  tbody.innerHTML = `
    <tr>
      <td colspan="5" class="text-center p-4 text-gray-500">
        <i class="fas fa-spinner fa-spin mr-2"></i>Cargando registros...
      </td>
    </tr>`;

  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(rawResponse => {
        if (!rawResponse) {
          showToast("El servidor no devolvió datos", "error");
          return;
        }
        try {
          const response = JSON.parse(rawResponse);
          if (!response.success) throw new Error(response.error || "Error en el servidor");
          
          allRecords = response.rows || [];
          renderTable(allRecords);
          actualizarProgreso(allRecords.length);
        } catch (parseError) {
          showToast("Formato de respuesta inválido", "error");
        }
      })
      .withFailureHandler(() => {
        showToast("Error al conectar con el servidor", "error");
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center p-4 text-red-500">
              <i class="fas fa-unlink mr-2"></i>Error de conexión
            </td>
          </tr>`;
      })
      .readData();
  } else {
    // Modo de desarrollo
    allRecords = [{
      ID: "dev1",
      folio: "DEV-001",
      nombre: "Modo Desarrollo",
      fechaDefuncion: "2023-01-01",
      area: "Desarrollo",
      edad: 30,
      sexo: "Femenino"
    }];
    renderTable(allRecords);
    showToast("Modo desarrollo: usando datos de prueba", "info");
  }
}

function editarRegistro(record) {
  const theId = record.id || record.ID || record.Id || "";
  document.getElementById('registro-id').value = theId;
  document.getElementById('folio').value = record.folio || '';
  document.getElementById('nombre').value = record.nombre || '';

  let fechaStr = '';
  if (record.fechaDefuncion) {
    const d = new Date(record.fechaDefuncion);
    fechaStr = isNaN(d) ? String(record.fechaDefuncion).slice(0,10) : d.toISOString().split('T')[0];
  }
  document.getElementById('fechaDefuncion').value = fechaStr;

  document.getElementById('area').value = record.area || '';
  document.getElementById('edad').value = record.edad || '';
  document.getElementById('expediente').value = record.expediente || '';
  document.getElementById('medico').value = record.medico || '';
  document.getElementById('diagnostico').value = record.diagnostico || '';
  document.getElementById('observaciones').value = record.observaciones || '';

  const sexoRadio = document.querySelector(`input[name="sexo"][value="${record.sexo || ''}"]`);
  if (sexoRadio) sexoRadio.checked = true;

  document.querySelector('#submit-text').innerHTML = '<i class="fas fa-save mr-2"></i> Actualizar';
  document.getElementById('crud-form').scrollIntoView({ behavior: 'smooth' });
}

function eliminarRegistro(id) {
  if (!id) { showToast('ID inválido', "error"); return; }
  if (!confirm('¿Estás seguro de que deseas eliminar este registro?')) return;

  google.script.run
    .withSuccessHandler(response => {
      if (response && response.success) {
        showToast('Registro eliminado correctamente');
        cargarRegistros();
      } else {
        showToast((response && response.error) || 'Error al eliminar registro', "error");
      }
    })
    .withFailureHandler(error => {
      showToast('Error al eliminar: ' + (error?.message || error), "error");
    })
    .deleteData(id);
}

function filtrarRegistros(e) {
  const searchTerm = e.target.value.toLowerCase();
  const filtered = allRecords.filter(record => 
    (record.numero && record.numero.toLowerCase().includes(searchTerm)) ||
    (record.nombre && record.nombre.toLowerCase().includes(searchTerm)) ||
    (record.area && record.area.toLowerCase().includes(searchTerm)) ||
    (record.fechaDefuncion && new Date(record.fechaDefuncion)
      .toLocaleDateString('es-MX').toLowerCase().includes(searchTerm))
  );
  renderTable(filtered);
}

function actualizarProgreso(count) {
  const max = 30;
  const percentage = Math.min(Math.round((count / max) * 100), 100);
  
  document.getElementById('progress-bar').style.width = `${percentage}%`;
  document.getElementById('progress-text').textContent = `${count}/${max} registros`;
  
  const progressBar = document.getElementById('progress-bar');
  progressBar.classList.remove('bg-blue-600', 'bg-green-600', 'bg-yellow-500', 'bg-red-600');
  
  if (percentage >= 100) {
    progressBar.classList.add('bg-green-600');
  } else if (percentage >= 75) {
    progressBar.classList.add('bg-blue-600');
  } else if (percentage >= 50) {
    progressBar.classList.add('bg-yellow-500');
  } else {
    progressBar.classList.add('bg-red-600');
  }
}

function guardarRegistro(e) {
  e.preventDefault();
  setLoading(true);

  const id = document.getElementById('registro-id').value;
  const nombre = document.getElementById('nombre').value;
  const fechaDefuncion = document.getElementById('fechaDefuncion').value;

  if (!nombre.trim()) {
    document.getElementById('nombre-error').classList.remove('hidden');
    document.getElementById('nombre').focus();
    setLoading(false);
    return;
  } else {
    document.getElementById('nombre-error').classList.add('hidden');
  }

  if (fechaDefuncion) {
    const fecha = new Date(fechaDefuncion);
    if (fecha > new Date()) {
      document.getElementById('fecha-error').classList.remove('hidden');
      setLoading(false);
      return;
    } else {
      document.getElementById('fecha-error').classList.add('hidden');
    }
  }

  const payload = {
    id,
    folio: document.getElementById('folio').value,
    nombre,
    fechaDefuncion,
    area: document.getElementById('area').value,
    edad: document.getElementById('edad').value,
    sexo: document.querySelector('input[name="sexo"]:checked')?.value || '',
    diagnostico: document.getElementById('diagnostico').value,
    expediente: document.getElementById('expediente').value,
    medico: document.getElementById('medico').value,
    observaciones: document.getElementById('observaciones').value
  };

  const runner = google.script.run
    .withSuccessHandler(response => {
      setLoading(false);
      if (!response) {
        showToast('No se recibió respuesta del servidor', "error");
        return;
      }
      if (response.success) {
        showToast(id ? 'Registro actualizado' : `Registro ${response.numero || ''} creado`);
        limpiarFormulario();
        cargarRegistros();
      } else {
        showToast(response.error || 'Error desconocido', "error");
      }
    })
    .withFailureHandler(error => {
      setLoading(false);
      showToast('Error al comunicarse con el servidor: ' + (error?.message || error), "error");
    });

  if (id) {
    runner.updateData(payload);
  } else {
    runner.createData(payload);
  }
}

function limpiarFormulario() {
  document.getElementById('crud-form').reset();
  document.getElementById('registro-id').value = '';
  document.querySelector('#submit-text').innerHTML = '<i class="fas fa-save mr-2"></i> Guardar';
  document.getElementById('nombre-error').classList.add('hidden');
  document.getElementById('fecha-error').classList.add('hidden');
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('crud-form').addEventListener('submit', guardarRegistro);
  document.getElementById('btn-limpiar').addEventListener('click', limpiarFormulario);
  document.getElementById('buscar-registro').addEventListener('input', filtrarRegistros);
  
  cargarRegistros();
  
  if (typeof google === 'undefined' || !google.script || !google.script.run) {
    document.body.classList.add('border-4', 'border-red-500');
    showToast("Modo desarrollo activado - Usando datos de prueba", "info");
  }
});
  </script>


</body>

</html>
