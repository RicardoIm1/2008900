<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>URGENCIAS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="caja.css">
</head>

<body>
  <div id="loader-pagina" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: black; display: flex; flex-direction: column; justify-content: center;
    align-items: center; z-index: 9999; font-family: 'Courier New', monospace; color: #0f0;">
    <div class="spinner"></div>
    <div style="margin-top: 10px;">Inicializando terminal...</div>
  </div>

  <div class="terminal-flex">
    <div class="terminal-escaneo">
      <h2>Ingresos por Urgencias</h2>
      <div id="reader"></div>
      <div id="status" style="width: 100%; text-align: center;">
        » PRESIONA "INICIAR ESCANEO" DESPUÉS DE LLENAR LOS CAMPOS «
      </div>

      <div id="formularioAdicional">
        <label for="motivo">MOTIVO:</label>
        <input type="text" id="motivo" placeholder="EJ. CAÍDA DE MOTOCICLETA" required>
        <label for="cajera">CAJERA:</label>
        <select id="cajera" required>
          <option value="">-- SELECCIONA TU NOMBRE --</option>
          <option value="ALICIA">ALICIA</option>
          <option value="ANGELICA">ANGELICA</option>
          <option value="BELEN">BELEN</option>
          <option value="FELIX">FELIX</option>
          <option value="KARLA V">KARLA V</option>
          <option value="ROCIO">ROCIO</option>
          <option value="RUBI">RUBI</option>
        </select>

        <label for="referencia">NÚMERO DE REFERENCIA:</label>
        <input type="text" id="referencia" placeholder="EJ. EXPEDIENTE" required>

        <label for="observaciones">OBSERVACIONES:</label>
        <textarea id="observaciones" placeholder="COMENTARIOS ADICIONALES..."></textarea>
      </div>

      <div class="button-group">
        <button id="btnStart">INICIAR ESCANEO</button>
        <button id="btnStop" disabled>DETENER</button>
        <div id="mensaje"></div>
      </div>
    </div>

    <div class="terminal-tabla">
      <div id="loader" style="display: none; text-align: center; margin: 10px 0;">
        <span class="spinner"></span>
        <div style="color: #0f0; font-family: 'Courier New'; margin-top: 5px;">Cargando datos...</div>
      </div>

      <input type="text" id="busqueda" placeholder="Buscar..." onkeyup="filtrarTabla()" 
             style="margin-bottom: 10px; width: 100%; padding: 6px; font-family: 'Courier New';">
      <table class="pacientes" id="pacientes">
        <thead>
          <tr>
            <th>FOLIO</th>
            <th>FECHA</th>
            <th>HORA</th>
            <th>CURP</th>
            <th>PATERNO</th>
            <th>MATERNO</th>
            <th>NOMBRE(S)</th>
            <th>FECHA DE NACIMIENTO</th>
            <th>SEXO</th>
            <th>ENTIDAD</th>
            <th>HOMOCLAVE</th>
            <th>MOTIVO</th>
            <th>EDAD</th>
            <th>CAJERA</th>
            <th>NUMERO DE REFERENCIA</th>
            <th>OBSERVACIONES</th>
          </tr>
        </thead>
        <tbody id="tabla-pacientes">
          <!-- Registros dinámicos -->
        </tbody>
      </table>
    </div>
  </div>

<script>
const URL_API = "https://script.google.com/macros/s/AKfycbx9IUHMV3lp1uNhUFwgFcMqY6PwRrdpimCnx9e8mpPE51aHQ4467VE4DpuIGfspKKSIag/exec";

function filtrarTabla() {
  const input = document.getElementById("busqueda").value.toLowerCase();
  const filas = document.querySelector("#tabla-pacientes").getElementsByTagName("tr");

  for (let i = 0; i < filas.length; i++) {
    const celdas = filas[i].getElementsByTagName("td");
    let coincide = false;
    for (let j = 0; j < celdas.length; j++) {
      const texto = celdas[j].textContent.toLowerCase();
      if (texto.includes(input)) { coincide = true; break; }
    }
    filas[i].style.display = coincide ? "" : "none";
  }
}

function cargarTabla() {
  fetch(URL_API)
    .then(res => res.json())
    .then(registros => {
      const cuerpo = document.getElementById("tabla-pacientes");
      cuerpo.innerHTML = "";
      if (!registros || registros.length === 0) {
        cuerpo.innerHTML = "<tr><td colspan='16' style='text-align:center'>No hay registros disponibles.</td></tr>";
        return;
      }
      registros.reverse().forEach(reg => {
        const fila = document.createElement("tr");
        [
          "FOLIO","FECHA","HORA","CURP","PATERNO","MATERNO","NOMBRE(S)",
          "FECHA DE NACIMIENTO","SEXO","ENTIDAD","HOMOCLAVE","MOTIVO","EDAD",
          "CAJERA","NUMERO DE REFERENCIA","OBSERVACIONES"
        ].forEach(campo => {
          const celda = document.createElement("td");
          celda.textContent = reg[campo] || "";
          fila.appendChild(celda);
        });
        cuerpo.appendChild(fila);
      });
    })
    .catch(err => console.error("Error al cargar registros:", err));
}

window.addEventListener("load", () => {
  const loader = document.getElementById('loader-pagina');
  if (loader) {
    setTimeout(() => {
      loader.style.transition = 'opacity 0.5s ease';
      loader.style.opacity = 0;
      setTimeout(() => loader.style.display = 'none', 500);
    }, 2000);
  }
  cargarTabla();
});

const btnStart = document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');
const status = document.getElementById('status');
const reader = document.getElementById('reader');
let html5QrCode, filaDestacada = null;

btnStart.addEventListener('click', () => {
  try {
    html5QrCode = new Html5Qrcode("reader");
    btnStart.disabled = true;
    btnStop.disabled = false;
    status.textContent = "» INICIANDO CÁMARA... «";
    reader.classList.add('scanning');

    const motivo = document.getElementById('motivo').value;
    const cajera = document.getElementById('cajera').value;
    const referencia = document.getElementById('referencia').value;
    const observaciones = document.getElementById('observaciones').value;

    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        const datosEnvio = {
          curp: decodedText.trim(),
          motivo, cajera, referencia, observaciones
        };

        fetch(URL_API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datosEnvio)
        })
        .then(res => res.json())
        .then(response => {
          if (response.success) {
            agregarRegistroNuevo(response.nuevoRegistro);
            status.innerHTML = `<span class="success-message">✓ REGISTRO EXITOSO: ${response.folio}</span>`;
            document.getElementById('motivo').value = '';
            document.getElementById('referencia').value = '';
            document.getElementById('observaciones').value = '';
          } else {
            status.innerHTML = `<span class="error-message">✗ ERROR: ${response.message}</span>`;
          }
        })
        .catch(err => {
          console.error("❌ Error al enviar:", err);
          status.innerHTML = `<span class="error-message">✗ ERROR DE CONEXIÓN ✗</span>`;
        });

        html5QrCode.stop().then(() => {
          btnStart.disabled = false;
          btnStop.disabled = true;
          reader.classList.remove('scanning');
        });
      }
    );
  } catch (err) {
    status.innerHTML = `<span class="error-message">ERROR: NO SE CARGÓ HTML5QRCODE</span>`;
    console.error(err);
  }
});

btnStop.addEventListener('click', () => {
  if (html5QrCode) {
    html5QrCode.stop().then(() => {
      status.textContent = "» ESCANEO DETENIDO «";
      btnStart.disabled = false;
      btnStop.disabled = true;
      reader.classList.remove('scanning');
    });
  }
});

function agregarRegistroNuevo(nuevoRegistro) {
  if (!nuevoRegistro) return;
  const cuerpoTabla = document.getElementById("tabla-pacientes");
  const fila = document.createElement("tr");
  [
    "FOLIO","FECHA","HORA","CURP","PATERNO","MATERNO","NOMBRE(S)",
    "FECHA DE NACIMIENTO","SEXO","ENTIDAD","HOMOCLAVE","MOTIVO","EDAD",
    "CAJERA","NUMERO DE REFERENCIA","OBSERVACIONES"
  ].forEach(campo => {
    const celda = document.createElement("td");
    celda.textContent = nuevoRegistro[campo] || "";
    fila.appendChild(celda);
  });
  if (filaDestacada) filaDestacada.classList.remove('nueva-fila');
  cuerpoTabla.insertBefore(fila, cuerpoTabla.firstChild);
  filaDestacada = fila;
  fila.classList.add('nueva-fila');
  setTimeout(() => fila.classList.remove('nueva-fila'), 5000);
}
</script>
</body>
</html>
