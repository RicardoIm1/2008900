<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>INGRESOS URGENCIAS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap" rel="stylesheet">
  <link href="caja2.css" rel="stylesheet">
</head>

<body>
  <!-- Loader -->
  <div id="loader-pagina">
    <div class="spinner"></div>
    <div style="margin-top: 10px;">Inicializando terminal...</div>
  </div>

  <!-- Panel de depuraci√≥n -->
  <div id="debug-info">
    <h3 style="margin-top: 0;">INFO DEPURACI√ìN</h3>
    <div id="debug-content"></div>
    <button onclick="document.getElementById('debug-info').style.display = 'none'" style="margin-top: 10px;">Cerrar</button>
  </div>

  <div class="terminal-flex">
    <!-- Escaneo + Formulario -->
    <div class="terminal-escaneo">
      <h2>Ingresos por Urgencias</h2>
      <div id="reader"></div>
      <div id="status" style="width: 100%; text-align: center; margin: 10px 0;">
        ¬ª PRESIONA "INICIAR ESCANEO" DESPU√âS DE LLENAR LOS CAMPOS ¬´
      </div>

      <div id="formularioAdicional">
        <label for="motivo">MOTIVO:</label>
        <input type="text" id="motivo" placeholder="EJ. CA√çDA DE MOTOCICLETA" required>

        <label for="cajera">CAJERA:</label>
        <select id="cajera" required>
          <option value="">-- SELECCIONA TU NOMBRE --</option>
          <option value="ALICIA">ALICIA</option>
          <option value="ANGELICA">ANGELICA</option>
          <option value="BELEN">BELEN</option>
          <option value="FELIX">FELIX</option>
          <option value="KARLA V">KARLA V</option>
          <option value="ROCIO">ROCIO</option>
          <option value="RUBI">RUBI</option>
        </select>

        <label for="referencia">N√öMERO DE REFERENCIA:</label>
        <input type="text" id="referencia" placeholder="EJ. EXPEDIENTE" required>

        <label for="observaciones">OBSERVACIONES:</label>
        <textarea id="observaciones" placeholder="COMENTARIOS ADICIONALES..."></textarea>
      </div>

      <div class="button-group">
        <button id="btnStart">INICIAR ESCANEO</button>
        <button id="btnStop" disabled>DETENER</button>
        <button id="btnRefresh" title="Actualizar tabla">ACTUALIZAR</button>
        <button id="btnExport" title="Exportar datos locales">EXPORTAR</button>
        <button id="btnDebug" title="Modo depuraci√≥n">DEPURAR</button>
      </div>
    </div>

    <!-- Tabla din√°mica -->
    <div class="terminal-tabla">
      <input type="text" id="busqueda" placeholder="Buscar..." 
             style="margin-bottom: 10px; width: 100%; padding: 6px; font-family: 'Courier New'; background: #222; color: #0f0; border: 1px solid #0f0;">
      <div id="modo-local" style="display: none; background: #331100; color: #ff9900; padding: 8px; margin-bottom: 10px; text-align: center;">
        ‚ö† MODO LOCAL: Los datos se guardan en este navegador
      </div>
      <table class="pacientes" id="pacientes">
        <thead>
          <tr>
            <th>FOLIO</th><th>FECHA</th><th>HORA</th><th>CURP</th><th>PATERNO</th><th>MATERNO</th>
            <th>NOMBRE(S)</th><th>FECHA NAC.</th><th>SEXO</th><th>ENTIDAD</th><th>HOMOCLAVE</th>
            <th>MOTIVO</th><th>EDAD</th><th>CAJERA</th><th>REFERENCIA</th><th>OBSERVACIONES</th>
          </tr>
        </thead>
        <tbody id="tabla-pacientes"></tbody>
      </table>
    </div>
  </div>

  <script>
    const URL_API = "https://script.google.com/macros/s/AKfycbwEgr4ICW8Rx8aPf5JPCUEoGKF3fOs8Cz9aUv69q5Jpiwd0vhoE950niuuWegpgqq7i0g/exec";
    let html5QrCode, filaDestacada = null;
    let usandoModoLocal = false;
    let ultimoFolio = "";
    let modoDebug = false;

    // Funci√≥n para mostrar informaci√≥n de depuraci√≥n
    function mostrarDebug(info) {
      if (!modoDebug) return;
      
      const debugInfo = document.getElementById('debug-info');
      const debugContent = document.getElementById('debug-content');
      
      debugInfo.style.display = 'block';
      debugContent.innerHTML = info + '<br><br>' + debugContent.innerHTML;
    }

    // Funci√≥n para filtrar la tabla
    function filtrarTabla() {
      const input = document.getElementById("busqueda").value.toLowerCase();
      const filas = document.querySelectorAll("#tabla-pacientes tr");
      
      filas.forEach(fila => {
        const celdas = fila.getElementsByTagName("td");
        let coincide = false;
        
        for (let j = 0; j < celdas.length; j++) {
          if (celdas[j].textContent.toLowerCase().includes(input)) { 
            coincide = true; 
            break; 
          }
        }
        
        fila.style.display = coincide ? "" : "none";
      });
    }

    // Funci√≥n para formatear fecha como dd/mm/yyyy
    function formatearFecha(fecha) {
      if (!fecha) return "";
      
      try {
        // Si ya est√° en formato dd/mm/yyyy, devolver tal cual
        if (typeof fecha === 'string' && fecha.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
          return fecha;
        }
        
        // Si es una fecha de JavaScript
        const date = new Date(fecha);
        if (isNaN(date.getTime())) return fecha;
        
        const dia = date.getDate().toString().padStart(2, '0');
        const mes = (date.getMonth() + 1).toString().padStart(2, '0');
        const anio = date.getFullYear();
        
        return `${dia}/${mes}/${anio}`;
      } catch (e) {
        return fecha;
      }
    }

    // Funci√≥n para formatear hora como HH:MM
    function formatearHora(fecha) {
      if (!fecha) return "";
      
      try {
        const date = new Date(fecha);
        if (isNaN(date.getTime())) {
          // Si es un string con formato de hora, devolver tal cual
          if (typeof fecha === 'string' && fecha.match(/^\d{2}:\d{2}$/)) {
            return fecha;
          }
          return fecha;
        }
        
        const horas = date.getHours().toString().padStart(2, '0');
        const minutos = date.getMinutes().toString().padStart(2, '0');
        
        return `${horas}:${minutos}`;
      } catch (e) {
        return fecha;
      }
    }

    // Funci√≥n para extraer y formatear fecha de nacimiento desde CURP
    function extraerFechaNacimientoDesdeCURP(curp) {
      if (!curp || curp.length < 10) return "";
      
      try {
        // Extraer fecha del CURP (posiciones 5-10: AAMMDD)
        // Ejemplo: RATJ800318HJCMRR07 -> 800318 (18/03/1980)
        const fechaStr = curp.substring(4, 10);
        if (fechaStr.length !== 6) return "";
        
        const anio = "19" + fechaStr.substring(0, 2); // 80 -> 1980
        const mes = fechaStr.substring(2, 4); // 03
        const dia = fechaStr.substring(4, 6); // 18
        
        return `${dia}/${mes}/${anio}`;
      } catch (e) {
        return "";
      }
    }

    // Funci√≥n para calcular edad desde fecha de nacimiento
    function calcularEdadDesdeFechaNacimiento(fechaNacimiento) {
      if (!fechaNacimiento) return "";
      
      try {
        // Convertir dd/mm/yyyy a fecha JavaScript
        const partes = fechaNacimiento.split('/');
        if (partes.length !== 3) return "";
        
        const dia = parseInt(partes[0], 10);
        const mes = parseInt(partes[1], 10) - 1; // Los meses en JS son 0-11
        const anio = parseInt(partes[2], 10);
        
        const nacimiento = new Date(anio, mes, dia);
        if (isNaN(nacimiento.getTime())) return "";
        
        const hoy = new Date();
        
        let edad = hoy.getFullYear() - nacimiento.getFullYear();
        
        // Ajustar si a√∫n no ha pasado el cumplea√±os este a√±o
        if (hoy.getMonth() < nacimiento.getMonth() || 
            (hoy.getMonth() === nacimiento.getMonth() && hoy.getDate() < nacimiento.getDate())) {
          edad--;
        }
        
        return edad.toString();
      } catch (error) {
        return "";
      }
    }

    // Funci√≥n para guardar datos en localStorage
    function guardarEnLocal(datos) {
      return new Promise((resolve) => {
        try {
          // Obtener datos existentes
          const registrosGuardados = JSON.parse(localStorage.getItem('registrosUrgencias') || '[]');
          
          // Obtener √∫ltimo folio local para hacerlo consecutivo
          let ultimoNumero = 0;
          registrosGuardados.forEach(reg => {
            if (reg.folio && reg.folio.startsWith("LOCAL-")) {
              const num = parseInt(reg.folio.split("-")[1]);
              if (!isNaN(num) && num > ultimoNumero) {
                ultimoNumero = num;
              }
            }
          });
          
          // Generar folio consecutivo
          const siguienteNumero = ultimoNumero + 1;
          const folio = "LOCAL-" + siguienteNumero.toString().padStart(5, '0');
          
          // Obtener fecha y hora actual formateadas
          const ahora = new Date();
          const fecha = formatearFecha(ahora);
          const hora = formatearHora(ahora);
          
          // Extraer y formatear fecha de nacimiento desde CURP
          const fechaNacimiento = extraerFechaNacimientoDesdeCURP(datos.curp);
          
          // Calcular edad autom√°ticamente
          const edad = calcularEdadDesdeFechaNacimiento(fechaNacimiento);
          
          // Crear registro completo
          const registro = {
            folio: folio,
            fecha: fecha,
            hora: hora,
            curp: datos.curp,
            paterno: "",
            materno: "",
            nombres: "",
            fecha_nacimiento: fechaNacimiento,
            sexo: "",
            entidad: "",
            homoclave: "",
            motivo: datos.motivo,
            edad: edad,
            cajera: datos.cajera,
            referencia: datos.referencia,
            observaciones: datos.observaciones
          };
          
          // Procesar informaci√≥n adicional del CURP si est√° disponible
          try {
            const partes = datos.curp.split('||');
            if (partes.length >= 2) {
              const datosCURP = partes[1].split('|');
              registro.paterno = datosCURP[0] || "";
              registro.materno = datosCURP[1] || "";
              registro.nombres = datosCURP[2] || "";
              registro.sexo = datosCURP[3] || "";
              registro.entidad = datosCURP[5] || "";
              registro.homoclave = datosCURP[7] || "";
            }
          } catch (e) {
            console.log("No se pudo extraer informaci√≥n adicional del CURP", e);
          }
          
          // Agregar a la lista
          registrosGuardados.push(registro);
          
          // Guardar en localStorage
          localStorage.setItem('registrosUrgencias', JSON.stringify(registrosGuardados));
          
          // Resolver con √©xito
          resolve({
            success: true,
            folio: folio,
            message: "Datos guardados correctamente con folio: " + folio,
            registro: registro
          });
        } catch (error) {
          resolve({
            success: false,
            message: "Error al guardar localmente: " + error.message
          });
        }
      });
    }

    // Funci√≥n para cargar la tabla desde localStorage
    function cargarDesdeLocal() {
      try {
        const registros = JSON.parse(localStorage.getItem('registrosUrgencias') || '[]');
        const cuerpo = document.getElementById("tabla-pacientes");
        cuerpo.innerHTML = "";
        
        if (registros.length === 0) {
          cuerpo.innerHTML = "<tr><td colspan='16' style='text-align:center'>No hay registros locales disponibles.</td></tr>";
          return;
        }
        
        // Ordenar registros por fecha y hora (m√°s recientes primero)
        registros.sort((a, b) => {
          try {
            // Convertir fechas formato dd/mm/yyyy a yyyy/mm/dd para comparaci√≥n
            const fechaAParts = a.fecha.split('/');
            const fechaBParts = b.fecha.split('/');
            const fechaAStr = `${fechaAParts[2]}/${fechaAParts[1]}/${fechaAParts[0]} ${a.hora}`;
            const fechaBStr = `${fechaBParts[2]}/${fechaBParts[1]}/${fechaBParts[0]} ${b.hora}`;
            return new Date(fechaBStr) - new Date(fechaAStr);
          } catch (e) {
            return 0;
          }
        });
        
        registros.forEach(reg => {
          const fila = document.createElement("tr");
          const campos = [
            reg.folio, reg.fecha, reg.hora, reg.curp, reg.paterno, reg.materno, reg.nombres,
            reg.fecha_nacimiento, reg.sexo, reg.entidad, reg.homoclave, reg.motivo, reg.edad,
            reg.cajera, reg.referencia, reg.observaciones
          ];
          
          campos.forEach(valor => {
            const celda = document.createElement("td");
            celda.textContent = valor || "";
            fila.appendChild(celda);
          });
          
          // Resaltar si es el √∫ltimo folio guardado
          if (reg.folio === ultimoFolio) {
            fila.classList.add('nueva-fila');
            setTimeout(() => fila.classList.remove('nueva-fila'), 3000);
          }
          
          cuerpo.appendChild(fila);
        });
      } catch (error) {
        console.error("Error al cargar registros locales:", error);
      }
    }

    // Funci√≥n para exportar datos locales
    function exportarDatosLocales() {
      try {
        const registros = JSON.parse(localStorage.getItem('registrosUrgencias') || '[]');
        if (registros.length === 0) {
          alert("No hay datos locales para exportar.");
          return;
        }
        
        // Convertir a CSV
        let csv = "FOLIO,FECHA,HORA,CURP,PATERNO,MATERNO,NOMBRES,FECHA_NACIMIENTO,SEXO,ENTIDAD,HOMOCLAVE,MOTIVO,EDAD,CAJERA,REFERENCIA,OBSERVACIONES\n";
        
        registros.forEach(reg => {
          csv += `"${reg.folio}","${reg.fecha}","${reg.hora}","${reg.curp}","${reg.paterno}","${reg.materno}","${reg.nombres}","${reg.fecha_nacimiento}","${reg.sexo}","${reg.entidad}","${reg.homoclave}","${reg.motivo}","${reg.edad}","${reg.cajera}","${reg.referencia}","${reg.observaciones}"\n`;
        });
        
        // Crear enlace de descarga
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const enlace = document.createElement('a');
        enlace.href = url;
        enlace.setAttribute('download', 'registros_urgencias.csv');
        document.body.appendChild(enlace);
        enlace.click();
        document.body.removeChild(enlace);
        
      } catch (error) {
        console.error("Error al exportar datos:", error);
        alert("Error al exportar datos: " + error.message);
      }
    }

    // Funci√≥n para enviar datos al servidor
    function enviarDatos(datos) {
      return new Promise((resolve) => {
        // Primero intentamos con fetch y el m√©todo tradicional
        const formData = new URLSearchParams();
        for (const key in datos) {
          formData.append(key, datos[key]);
        }
        
        mostrarDebug(`Enviando datos a: ${URL_API}`);
        mostrarDebug(`Datos: ${formData.toString()}`);
        
        fetch(URL_API, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: formData
        })
        .then(response => {
          mostrarDebug(`Respuesta recibida. Status: ${response.status}`);
          
          // Intentamos leer la respuesta como texto primero
          return response.text().then(text => {
            mostrarDebug(`Contenido respuesta: ${text}`);
            
            // Si la respuesta est√° vac√≠a, asumimos √©xito
            if (!text || text.trim() === '') {
              mostrarDebug("Respuesta vac√≠a del servidor, asumiendo √©xito");
              return {
                success: true,
                folio: "GAS-" + new Date().getTime().toString().slice(-6),
                message: "Datos enviados al servidor correctamente"
              };
            }
            
            // Intentamos parsear como JSON
            try {
              const jsonResponse = JSON.parse(text);
              mostrarDebug("Respuesta parseada como JSON correctamente");
              return jsonResponse;
            } catch (e) {
              mostrarDebug(`Error parseando JSON: ${e.message}`);
              
              // Si no es JSON pero contiene "√©xito" o similar, asumimos √©xito
              if (text.toLowerCase().includes('√©xito') || text.toLowerCase().includes('exito') || 
                  text.toLowerCase().includes('success') || text.toLowerCase().includes('folio')) {
                return {
                  success: true,
                  folio: "GAS-" + new Date().getTime().toString().slice(-6),
                  message: "Datos enviados al servidor: " + text
                };
              }
              
              // Si no podemos determinar el √©xito, guardamos localmente
              throw new Error('Respuesta no reconocida: ' + text);
            }
          });
        })
        .then(response => {
          resolve(response);
        })
        .catch(error => {
          mostrarDebug(`Error en la solicitud: ${error.message}`);
          console.warn("Error al enviar datos al servidor, guardando localmente:", error);
          // Si falla, guardar localmente
          guardarEnLocal(datos).then(resolve);
        });
      });
    }

    // üìã Carga registros desde Google Sheets
    function cargarTabla() {
      mostrarDebug("Cargando tabla desde: " + URL_API + '?action=get');
      
      fetch(URL_API + '?action=get')
        .then(response => {
          mostrarDebug(`Respuesta GET recibida. Status: ${response.status}`);
          return response.text();
        })
        .then(text => {
          let registros;
          
          // Si la respuesta est√° vac√≠a, intentamos cargar desde localStorage
          if (!text || text.trim() === '') {
            mostrarDebug("Respuesta vac√≠a del servidor");
            throw new Error('Respuesta vac√≠a del servidor');
          }
          
          // Intentar parsear como JSON
          try {
            registros = JSON.parse(text);
            mostrarDebug(`Datos parseados correctamente. Registros: ${registros.length}`);
          } catch (e) {
            mostrarDebug(`Error parseando JSON: ${e.message}`);
            console.warn("Respuesta GET no es JSON v√°lido, usando datos locales");
            throw new Error('Respuesta no JSON');
          }
          
          const cuerpo = document.getElementById("tabla-pacientes");
          cuerpo.innerHTML = "";
          
          if (!registros || registros.length === 0) {
            cuerpo.innerHTML = "<tr><td colspan='16' style='text-align:center'>No hay registros disponibles.</td></tr>";
            return;
          }
          
          // Ordenar registros (m√°s recientes primero)
          registros.sort((a, b) => {
            try {
              // Convertir fechas formato dd/mm/yyyy a yyyy/mm/dd para comparaci√≥n
              const fechaAParts = a.FECHA.split('/');
              const fechaBParts = b.FECHA.split('/');
              const fechaA = new Date(`${fechaAParts[2]}/${fechaAParts[1]}/${fechaAParts[0]} ${a.HORA}`);
              const fechaB = new Date(`${fechaBParts[2]}/${fechaBParts[1]}/${fechaBParts[0]} ${b.HORA}`);
              return fechaB - fechaA;
            } catch (e) {
              return 0;
            }
          });
          
          // Asegurar que los campos de fecha est√©n formateados correctamente
          registros.forEach(reg => {
            reg.FECHA = formatearFecha(reg.FECHA);
            reg.HORA = formatearHora(reg.HORA);
            reg['FECHA DE NACIMIENTO'] = formatearFecha(reg['FECHA DE NACIMIENTO']);
          });
          
          // Mostrar registros
          registros.forEach(reg => {
            const fila = document.createElement("tr");
            [
              "FOLIO", "FECHA", "HORA", "CURP", "PATERNO", "MATERNO", "NOMBRE(S)",
              "FECHA DE NACIMIENTO", "SEXO", "ENTIDAD", "HOMOCLAVE", "MOTIVO", "EDAD", "CAJERA",
              "NUMERO DE REFERENCIA", "OBSERVACIONES"
            ].forEach(campo => {
              const celda = document.createElement("td");
              celda.textContent = reg[campo] || "";
              fila.appendChild(celda);
            });
            
            // Resaltar si es el √∫ltimo folio guardado
            if (reg.FOLIO === ultimoFolio) {
              fila.classList.add('nueva-fila');
              setTimeout(() => fila.classList.remove('nueva-fila'), 3000);
            }
            
            cuerpo.appendChild(fila);
          });
          
          // Ocultar alerta de modo local
          document.getElementById("modo-local").style.display = "none";
          usandoModoLocal = false;
        })
        .catch(err => {
          mostrarDebug(`Error cargando tabla: ${err.message}`);
          console.warn("Error al cargar desde servidor, cargando datos locales:", err);
          // Mostrar alerta de modo local
          document.getElementById("modo-local").style.display = "block";
          usandoModoLocal = true;
          // Cargar desde localStorage
          cargarDesdeLocal();
        });
    }

    // üì∏ Inicializa el esc√°ner QR
    function iniciarEscanerQR() {
      // Esta funci√≥n se mantiene para compatibilidad
      console.log("Iniciar esc√°ner QR");
    }

    // üßæ Muestra mensajes al usuario
    function mostrarMensaje(texto) {
      const status = document.getElementById("status");
      status.innerHTML = texto;
      setTimeout(() => {
        status.innerHTML = "¬ª PRESIONA 'INICIAR ESCANEO' DESPU√âS DE LLENAR LOS CAMPOS ¬´";
      }, 3000);
    }

    // Inicializaci√≥n cuando carga la p√°gina
    window.addEventListener("load", () => {
      const loader = document.getElementById('loader-pagina');
      setTimeout(() => {
        loader.style.transition = 'opacity 0.5s ease';
        loader.style.opacity = 0;
        setTimeout(() => loader.style.display = 'none', 500);
        cargarTabla();
      }, 2000);
      
      // Configurar evento de b√∫squeda
      document.getElementById("busqueda").addEventListener("keyup", filtrarTabla);
      
      // Configurar bot√≥n de actualizaci√≥n
      document.getElementById("btnRefresh").addEventListener("click", cargarTabla);
      
      // Configurar bot√≥n de exportaci√≥n
      document.getElementById("btnExport").addEventListener("click", exportarDatosLocales);
      
      // Configurar bot√≥n de depuraci√≥n
      document.getElementById("btnDebug").addEventListener("click", () => {
        modoDebug = !modoDebug;
        mostrarDebug("Modo depuraci√≥n " + (modoDebug ? "activado" : "desactivado"));
        document.getElementById("btnDebug").textContent = modoDebug ? "OCULTAR DEBUG" : "DEPURAR";
      });
    });

    // Manejo de botones de escaneo
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const status = document.getElementById('status');
    const reader = document.getElementById('reader');

    btnStart.addEventListener('click', () => {
      // Validar formulario
      const motivo = document.getElementById('motivo').value;
      const cajera = document.getElementById('cajera').value;
      const referencia = document.getElementById('referencia').value;
      
      if (!motivo || !cajera || !referencia) {
        mostrarMensaje(`<span class="error-message">‚úó COMPLETA TODOS LOS CAMPOS OBLIGATORIOS ‚úó</span>`);
        return;
      }
      
      try {
        html5QrCode = new Html5Qrcode("reader");
        btnStart.disabled = true; 
        btnStop.disabled = false;
        status.textContent = "¬ª INICIANDO C√ÅMARA... ¬´";
        reader.classList.add('scanning');

        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            const datosEnvio = {
              curp: decodedText.trim(),
              motivo: document.getElementById('motivo').value,
              cajera: document.getElementById('cajera').value,
              referencia: document.getElementById('referencia').value,
              observaciones: document.getElementById('observaciones').value,
              action: "insert"
            };

            mostrarDebug(`CURP escaneado: ${decodedText}`);
            
            // Enviar datos
            enviarDatos(datosEnvio)
            .then(response => {
              if (response && response.success) {
                ultimoFolio = response.folio;
                
              if (response && response.success) {
  mostrarMensaje(`<span class="${response.registro ? "warning-message" : "success-message"}">
    ${response.registro ? "‚ö† REGISTRO LOCAL:" : "‚úì REGISTRO EXITOSO:"} ${response.folio}
  </span>`);

                  // Si vino del servidor no trae "registro", lo construimos r√°pido:
                  const registro = response.registro || {
                    folio: response.folio,
                    fecha: formatearFecha(new Date()),
                    hora: formatearHora(new Date()),
                    curp: datosEnvio.curp,
                    paterno: "",
                    materno: "",
                    nombres: "",
                    fecha_nacimiento: extraerFechaNacimientoDesdeCURP(datosEnvio.curp),
                    sexo: "",
                    entidad: "",
                    homoclave: "",
                    motivo: datosEnvio.motivo,
                    edad: calcularEdadDesdeFechaNacimiento(extraerFechaNacimientoDesdeCURP(datosEnvio.curp)),
                    cajera: datosEnvio.cajera,
                    referencia: datosEnvio.referencia,
                    observaciones: datosEnvio.observaciones
                  };
                
                  ultimoFolio = response.folio;
                  agregarRegistroATabla(registro);
                
                  // Limpiar formulario
                  document.getElementById('motivo').value = '';
                  document.getElementById('referencia').value = '';
                  document.getElementById('observaciones').value = '';
                } else {
                  const errorMsg = response && response.message ? response.message : 'Error desconocido';
                  mostrarMensaje(`<span class="error-message">‚úó ERROR: ${errorMsg}</span>`);
                  mostrarDebug(`Error completo: ${JSON.stringify(response)}`);
                }
              
                // Limpiar formulario
                document.getElementById('motivo').value = '';
                document.getElementById('referencia').value = '';
                document.getElementById('observaciones').value = '';
              } else {
                const errorMsg = response && response.message ? response.message : 'Error desconocido';
                mostrarMensaje(`<span class="error-message">‚úó ERROR: ${errorMsg}</span>`);
                mostrarDebug(`Error completo: ${JSON.stringify(response)}`);
              }
            })
            .catch(err => {
              console.error(err);
              mostrarMensaje(`<span class="error-message">‚úó ERROR DE CONEXI√ìN ‚úó</span>`);
              mostrarDebug(`Error de conexi√≥n: ${err.message}`);
            });

            html5QrCode.stop().then(() => {
              btnStart.disabled = false; 
              btnStop.disabled = true;
              reader.classList.remove('scanning');
            });
          },
          (errorMessage) => {
            // Ignorar mensajes de error mientras se escanea
          }
        ).catch(err => {
          console.error(err);
          mostrarMensaje(`<span class="error-message">‚úó ERROR AL INICIAR C√ÅMARA ‚úó</span>`);
          btnStart.disabled = false; 
          btnStop.disabled = true;
          reader.classList.remove('scanning');
        });
      } catch (err) {
        console.error(err);
        mostrarMensaje(`<span class="error-message">ERROR: NO SE CARG√ì HTML5QRCODE</span>`);
        btnStart.disabled = false; 
        btnStop.disabled = true;
        reader.classList.remove('scanning');
      }
    });

    // Funci√≥n para agregar un nuevo registro a la tabla
    function agregarRegistroATabla(registro) {
      const cuerpo = document.getElementById("tabla-pacientes");
      
      // Si la tabla est√° vac√≠a, eliminar el mensaje de "no hay registros"
      if (cuerpo.innerHTML.includes("No hay registros")) {
        cuerpo.innerHTML = "";
      }
      
      const fila = document.createElement("tr");
      
      // Asegurar formato correcto de fechas
      registro.fecha = formatearFecha(registro.fecha);
      registro.hora = formatearHora(registro.hora);
      registro.fecha_nacimiento = formatearFecha(registro.fecha_nacimiento);
      
      // Mapear campos para coincidir con los encabezados de la tabla
      const campos = [
        registro.folio, 
        registro.fecha, 
        registro.hora, 
        registro.curp, 
        registro.paterno, 
        registro.materno, 
        registro.nombres,
        registro.fecha_nacimiento, 
        registro.sexo, 
        registro.entidad, 
        registro.homoclave, 
        registro.motivo, 
        registro.edad, 
        registro.cajera, 
        registro.referencia, 
        registro.observaciones
      ];
      
      campos.forEach(valor => {
        const celda = document.createElement("td");
        celda.textContent = valor || "";
        fila.appendChild(celda);
      });
      
      // Destacar la nueva fila
      fila.classList.add('nueva-fila');
      cuerpo.insertBefore(fila, cuerpo.firstChild);
      
      // Quitar el destacado despu√©s de 3 segundos
      setTimeout(() => {
        fila.classList.remove('nueva-fila');
      }, 3000);
    }

    btnStop.addEventListener('click', () => {
      if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => {
          status.textContent = "¬ª ESCANEO DETENIDO ¬´";
          btnStart.disabled = false; 
          btnStop.disabled = true;
          reader.classList.remove('scanning');
        }).catch(err => {
          console.error(err);
          status.textContent = "¬ª ERROR AL DETENER ESCANEO ¬´";
          btnStart.disabled = false; 
          btnStop.disabled = true;
          reader.classList.remove('scanning');
        });
      }
    });

    // üîπ Detectar click en celdas
    document.addEventListener("click", (e) => {
      if (e.target.tagName === "TD") {
        const valor = e.target.textContent.trim();
        if (valor) {
          alert("Celda seleccionada: " + valor);
        }
      }
    });

  </script>
</body>
</html>
